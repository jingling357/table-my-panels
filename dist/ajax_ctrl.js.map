{"version":3,"sources":["../src/ajax_ctrl.js"],"names":["MetricsPanelCtrl","_","kbn","TimeSeries","moment","$","panelDefaults","method","url","errorMode","params_js","display_js","AjaxCtrl","$scope","$injector","templateSrv","$sce","$http","defaults","panel","timeSettings","events","on","onInitEditMode","bind","onPanelInitalized","onRefresh","onRender","datasource","updateTimeRange","console","log","updateFN","editorTabs","splice","addEditorTab","pluginId","editorTabIndex","params_fn","display_fn","Function","ex","warn","param","key","that","paramStr","constructor","String","Number","Boolean","encodeURIComponent","each","i","k","Array","onParseParam","substr","params","data","pageInfo","num","pageSize","totalPage","pageIndex","goPage","pno","psize","paramsData","JSON","stringify","headers","then","successCallback","response","html","object","nextData","total","perPageSize","parseInt","startPage","Math","max","endPage","pageStr","j","activeClass","liStr","append","empty","updateContent","errorCallback","body","e","el","target","text","content","templateUrl"],"mappings":"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","file":"ajax_ctrl.js","sourcesContent":["import { MetricsPanelCtrl } from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport TimeSeries from 'app/core/time_series';\nimport moment from 'moment';\nimport $ from 'jquery';\nimport './css/ajax-panel.css!';\n\nconst panelDefaults = {\n    method: 'GET',\n    url: 'https://raw.githubusercontent.com/ryantxu/ajax-panel/master/static/example.txt',\n    errorMode: 'show',\n    params_js: \"{\\n\" +\n        \" from:ctrl.range.from.format('x'),  // x is unix ms timestamp\\n\" +\n        \" to:ctrl.range.to.format('x'), \\n\" +\n        \" height:ctrl.height\\n\" +\n        \"}\",\n    display_js: null\n};\n\nexport class AjaxCtrl extends MetricsPanelCtrl {\n    // constructor($scope, $injector, private templateSrv, private $sce) {\n    constructor($scope, $injector, templateSrv, $sce, $http) {\n\n        super($scope, $injector);\n        this.$sce = $sce;\n        this.$http = $http;\n        this.templateSrv = templateSrv;\n\n        _.defaults(this.panel, panelDefaults);\n        _.defaults(this.panel.timeSettings, panelDefaults.timeSettings);\n\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n        this.events.on('panel-initialized', this.onPanelInitalized.bind(this));\n        this.events.on('refresh', this.onRefresh.bind(this));\n        this.events.on('render', this.onRender.bind(this));\n        //this.events.on('parseParam', this.onParseParam.bind(this));\n    }\n\n    // This just skips trying to send the actual query.  perhaps there is a better way\n    issueQueries(datasource) {\n        this.updateTimeRange();\n\n        console.log('block issueQueries', datasource);\n    }\n\n    onPanelInitalized() {\n        this.updateFN();\n    }\n\n    onInitEditMode() {\n        this.editorTabs.splice(1, 1); // remove the 'Metrics Tab'\n        this.addEditorTab('Options', 'public/plugins/' + this.pluginId + '/editor.html', 1);\n        this.editorTabIndex = 1;\n\n        this.updateFN();\n    }\n\n    onPanelTeardown() {\n        // this.$timeout.cancel(this.nextTickPromise);\n    }\n\n    updateFN() {\n        this.params_fn = null;\n        this.display_fn = null;\n\n        if (this.panel.params_js) {\n            try {\n                this.params_fn = new Function('ctrl', 'return ' + this.panel.params_js);\n            } catch (ex) {\n                console.warn('error parsing params_js', this.panel.params_js, ex);\n                this.params_fn = null;\n            }\n        }\n\n        // NOTE, this is not exposed yet\n        if (this.panel.display_js) {\n            try {\n                this.display_fn = new Function('ctrl', 'response', this.panel.display_js);\n            } catch (ex) {\n                console.warn('error parsing display_js', this.panel.display_js, ex);\n                this.display_fn = null;\n            }\n        }\n\n        this.onRefresh();\n    }\n\n    onParseParam(param, key) {\n        var that = this;\n        var paramStr = \"\";\n        if (param.constructor == String || param.constructor == Number || param.constructor == Boolean) {\n            paramStr += \"&\" + key + \"=\" + encodeURIComponent(param);\n        } else {\n            $.each(param, function(i) {\n                var k = key == null ? i : key + (param instanceof Array ? \"[\" + i + \"]\" : \".\" + i);\n                paramStr += '&' + that.onParseParam(this, k);\n            });\n        }\n        return paramStr.substr(1);\n    }\n\n    onRefresh() {\n        //console.log('refresh', this);\n        this.updateTimeRange(); // needed for the first call\n\n        var that = this;\n        var params;\n        if (this.params_fn) {\n            params = this.params_fn(this);\n        }\n\n\n        var data, pageInfo, num, pageSize;\n        var totalPage = 0,\n            pageIndex = 1;\n\n        function goPage(pno, psize) {\n            var paramsData = {\n                'method.name': 'mash5.task.queryFeeds',\n                'method.optimize': 'fetchOne',\n                'query.bo._id': '4f8d24b8632a848bd909b577@TGZ.Bo',\n                'user.sessionId': '-5108224830335736294594b863fa7b11b00010bd76e',\n                'page.curPage': pno,\n                // 'query.bo.Fields.1.Value[]': '故障上报',\n                //'query.bo.Fields.1.Value': '自动上报',\n                'condition.$or': JSON.stringify([{ \"bo.Fields.7.Value\": \"等待审核\" }, { \"bo.Fields.7.Value\": \"上报人已确认\" }, { \"bo.Fields.7.Value\": \"完成\", \"bo.Fields.11.Value.id\": \"57fcaf794dec600d30ae0bd1@0.User\" }, { \"bo.Fields.7.Value\": \"已批待完成\", \"bo.Fields.10.Value.id\": \"57fcaf794dec600d30ae0bd1@0.User\" }, { \"bo.Fields.7.Value\": \"因故搁置\", \"bo.Fields.10.Value.id\": \"57fcaf794dec600d30ae0bd1@0.User\" }])\n            };\n            that.$http({\n                method: that.panel.method,\n                url: that.panel.url,\n                headers: {\n                    'Content-Type': \"application/x-www-form-urlencoded; charset=UTF-8\"\n                },\n                data: that.onParseParam(paramsData)\n            }).then(function successCallback(response) {\n                var html = response.data.object;\n\n                data = html.nextData;\n                pageInfo = html.pageInfo;\n                num = pageInfo.total; //表格所有行数(所有记录数)  \n                pageSize = pageInfo.perPageSize; //每页显示行数  \n\n                //总共分几页   \n                if (num / pageSize > parseInt(num / pageSize)) {\n                    totalPage = parseInt(num / pageSize) + 1;\n                } else {\n                    totalPage = parseInt(num / pageSize);\n                }\n\n                var startPage = Math.max(pageIndex - 3, 1);\n                var endPage = Math.max(pageSize, startPage + 9);\n\n                if (endPage > totalPage) {\n                    endPage = totalPage + 1;\n                }\n                var pageStr = $('<ul></ul>');\n                for (var j = startPage; j < endPage; j++) {\n                    var activeClass = j === pageIndex ? 'active' : '';\n                    var liStr = $('<li><a class=\"table-panel-page-link pointer ' + activeClass + '\">' + j + '</a></li>');\n                    pageStr.append(liStr);\n                }\n                $('#table-page').empty().append(pageStr);\n\n                that.updateContent(html.nextData);\n                // that.onRender(html);\n            }, function errorCallback(response) {\n                console.warn('error', response);\n                var body = '<h1>Error</h1><pre>' + JSON.stringify(response, null, \" \") + \"</pre>\";\n                that.updateContent(body);\n            });\n        }\n\n        goPage(pageIndex, pageSize);\n        $('#table-page').bind('click', 'li', function(e) {\n            var el = $(e.target);\n            pageIndex = parseInt(el.text());\n            goPage(pageIndex, pageSize)\n        });\n    }\n\n    onRender(html) {\n        var that = this;\n        var data = html.nextData;\n        var pageInfo = html.pageInfo;\n        var num = pageInfo.total; //表格所有行数(所有记录数)  \n\n        var pageSize = pageInfo.perPageSize; //每页显示行数  \n        var totalPage = 0;\n        var pageIndex = 1;\n\n        // //总共分几页   \n        // if (num / pageSize > parseInt(num / pageSize)) {\n        //     totalPage = parseInt(num / pageSize) + 1;\n        // } else {\n        //     totalPage = parseInt(num / pageSize);\n        // }\n        // var pageStr = $('<ul></ul>');\n        // for (var j = 1; j <= totalPage; j++) {\n        //     //   var activeClass = j === pageIndex ? 'active' : '';\n        //     var liStr = $('<li><a class=\"table-panel-page-link pointer\">' + j + '</a></li>');\n        //     pageStr.append(liStr);\n        // }\n        // $('#table-page').empty().append(pageStr);\n    }\n\n    updateContent(html) {\n        try {\n            this.content = html;\n        } catch (e) {\n            console.log('Text panel error: ', e);\n            this.content = JSON.stringify(html);\n        }\n    }\n\n    //onRender() {\n    //console.log('render', this);\n    // }\n\n}\n\nAjaxCtrl.templateUrl = 'module.html';\n"]}